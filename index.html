<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İngiliz Kültür Koleji - Erken Kayıt Randevusu</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Facebook Pixel -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1233557722304266');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1233557722304266&ev=PageView&noscript=1"
    /></noscript>
    
    <style>
        :root {
            --primary: #d90429;
            --secondary: #2b2d42;
            --light: #edf2f4;
            --dark: #1a1b2e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            margin: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--secondary), var(--dark));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .logo {
            max-width: 180px;
            height: auto;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px;
            text-align: center;
            color: #856404;
            font-weight: 600;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 4, 41, 0.1);
        }
        
        .date-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            display: block;
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .room-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .room-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .room-card.selected {
            border-color: var(--secondary);
            background: var(--secondary);
            color: white;
        }
        
        .room-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .room-card h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .room-card p {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .time-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .time-option {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .time-option:hover {
            border-color: var(--primary);
        }
        
        .time-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .time-option.disabled {
            background: #f8f9fa;
            color: #999;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .captcha-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
        }
        
        .captcha-box {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--secondary);
        }
        
        .captcha-input {
            flex: 1;
        }
        
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            background: #b90324;
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }
            
            .header, .form-container {
                padding: 20px;
            }
            
            .rooms-grid, .time-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://i.ibb.co/bgx6xhMQ/ikk-LOGO-PNG.png" alt="İngiliz Kültür Koleji" class="logo">
            <h1 class="title">Erken Kayıt Randevusu</h1>
            <p class="subtitle">2026-2027 Eğitim Öğretim Yılı</p>
        </div>
        
        <div class="warning-box">
            ⚠️ Bu alandan sadece kurumumuz öğrencisi OLMAYAN veliler randevu alabilir.
        </div>
        
        <div class="form-container">
            <form id="appointmentForm">
                <div class="form-group">
                    <label for="parentName">Veli Adı Soyadı *</label>
                    <input type="text" id="parentName" placeholder="Ahmet Yılmaz" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Telefon Numarası *</label>
                    <input type="tel" id="phone" placeholder="05XX XXX XX XX" required>
                </div>
                
                <div class="form-group">
                    <label for="studentName">Öğrenci Adı Soyadı *</label>
                    <input type="text" id="studentName" placeholder="Can Yılmaz" required>
                </div>
                
                <div class="form-group">
                    <label for="grade">Öğrenci Sınıf Seviyesi (Seneye Okuyacağı) *</label>
                    <select id="grade" required>
                        <option value="">Seçiniz</option>
                        <option value="Anaokulu">Anaokulu</option>
                        <option value="1">1. Sınıf</option>
                        <option value="2">2. Sınıf</option>
                        <option value="3">3. Sınıf</option>
                        <option value="4">4. Sınıf</option>
                        <option value="5">5. Sınıf</option>
                        <option value="6">6. Sınıf</option>
                        <option value="7">7. Sınıf</option>
                        <option value="8">8. Sınıf</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="appointmentDate">Randevu Tarihi *</label>
                    <input type="date" id="appointmentDate" required>
                    <span class="date-info">Pazar günleri kurumumuz kapalıdır.</span>
                </div>
                
                <div class="form-group">
                    <label>Görüşme Odası *</label>
                    <div class="rooms-grid">
                        <div class="room-card" id="room-oxford" onclick="selectRoom('oxford')">
                            <h4>Oxford</h4>
                            <p>Görüşme Odası 1</p>
                        </div>
                        <div class="room-card disabled">
                            <h4>Manchester</h4>
                            <p>Yakında</p>
                        </div>
                        <div class="room-card disabled">
                            <h4>Liverpool</h4>
                            <p>Yakında</p>
                        </div>
                        <div class="room-card disabled">
                            <h4>Cambridge</h4>
                            <p>Yakında</p>
                        </div>
                    </div>
                    <input type="hidden" id="selectedRoom" required>
                </div>
                
                <div class="form-group">
                    <label>Randevu Saati *</label>
                    <div class="time-options" id="timeOptions">
                        <div class="time-option" onclick="selectTime('09:30')">09:30</div>
                        <div class="time-option" onclick="selectTime('10:30')">10:30</div>
                        <div class="time-option" onclick="selectTime('11:30')">11:30</div>
                        <div class="time-option" onclick="selectTime('13:30')">13:30</div>
                        <div class="time-option" onclick="selectTime('14:30')">14:30</div>
                        <div class="time-option" onclick="selectTime('15:30')">15:30</div>
                        <div class="time-option" onclick="selectTime('16:30')">16:30</div>
                    </div>
                    <input type="hidden" id="selectedTime" required>
                </div>
                
                <div class="form-group">
                    <label>Güvenlik Doğrulaması *</label>
                    <div class="captcha-container">
                        <div class="captcha-box" id="captchaDisplay"></div>
                        <input type="number" class="captcha-input" id="captchaInput" placeholder="Sonucu girin" required>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    Randevu Oluştur
                </button>
                
                <div class="message" id="message"></div>
            </form>
        </div>
    </div>

    <script>
        // APPSCRIPT URL - BURAYI KENDİ URL'NİZLE DEĞİŞTİRİN
        const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbxsUQaGqcXO8adbSivmbw03CNSYYCRCITpvj8LBNl5oKDv27OEDwLiJvESo774H1y0/exec";
        
        // Değişkenler
        let selectedRoom = '';
        let selectedTime = '';
        let mathResult = 0;
        let takenSlots = [];
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            // Tarih sınırlamalarını ayarla
            setupDateConstraints();
            
            // CAPTCHA oluştur
            generateCaptcha();
            
            // Form gönderimini dinle
            document.getElementById('appointmentForm').addEventListener('submit', handleSubmit);
            
            // Tarih değiştiğinde doluluk kontrolü yap
            document.getElementById('appointmentDate').addEventListener('change', checkAvailability);
        });
        
        // Tarih sınırlamalarını ayarla
        function setupDateConstraints() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // En erken yarın için randevu alınabilir
            const minDate = tomorrow.toISOString().split('T')[0];
            
            // 1 yıl sonrasına kadar randevu alınabilir
            const maxDate = new Date(today);
            maxDate.setFullYear(maxDate.getFullYear() + 1);
            const maxDateStr = maxDate.toISOString().split('T')[0];
            
            document.getElementById('appointmentDate').min = minDate;
            document.getElementById('appointmentDate').max = maxDateStr;
        }
        
        // CAPTCHA oluştur
        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            mathResult = num1 + num2;
            document.getElementById('captchaDisplay').textContent = `${num1} + ${num2} = ?`;
        }
        
        // Oda seçimi
        function selectRoom(room) {
            selectedRoom = room;
            
            // Tüm odaların seçimini kaldır
            document.querySelectorAll('.room-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Seçili odayı işaretle
            document.getElementById(`room-${room}`).classList.add('selected');
            document.getElementById('selectedRoom').value = room;
            
            // Doluluk kontrolü yap
            checkAvailability();
        }
        
        // Saat seçimi
        function selectTime(time) {
            const timeOption = event.target;
            
            // Eğer saat doluysa seçime izin verme
            if (timeOption.classList.contains('disabled')) {
                return;
            }
            
            selectedTime = time;
            
            // Tüm saatlerin seçimini kaldır
            document.querySelectorAll('.time-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Seçili saati işaretle
            timeOption.classList.add('selected');
            document.getElementById('selectedTime').value = time;
        }
        
        // Doluluk kontrolü
        async function checkAvailability() {
            const date = document.getElementById('appointmentDate').value;
            const room = selectedRoom;
            
            if (!date || !room) {
                return;
            }
            
            // Pazar günü kontrolü
            const selectedDate = new Date(date);
            if (selectedDate.getDay() === 0) {
                alert('Pazar günü kurumumuz kapalıdır. Lütfen başka bir tarih seçin.');
                document.getElementById('appointmentDate').value = '';
                return;
            }
            
            // Saat seçeneklerini sıfırla
            document.querySelectorAll('.time-option').forEach(option => {
                option.classList.remove('selected', 'disabled');
            });
            document.getElementById('selectedTime').value = '';
            selectedTime = '';
            
            // Yükleme durumu
            document.getElementById('timeOptions').innerHTML = '<div class="loading">Doluluk kontrol ediliyor...</div>';
            
            try {
                // AppScript'ten doluluk bilgilerini al
                const response = await fetch(`${APPSCRIPT_URL}?date=${date}&room=${room}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP hatası: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    takenSlots = data.taken || [];
                    updateTimeOptions();
                } else {
                    throw new Error(data.message || 'Doluluk bilgisi alınamadı');
                }
                
            } catch (error) {
                console.error('Doluluk kontrolü hatası:', error);
                document.getElementById('timeOptions').innerHTML = `
                    <div style="color: #dc2626; text-align: center; padding: 20px;">
                        Doluluk bilgisi yüklenemedi. Lütfen sayfayı yenileyin.
                    </div>
                `;
            }
        }
        
        // Saat seçeneklerini güncelle
        function updateTimeOptions() {
            const timeOptions = [
                '09:30', '10:30', '11:30', 
                '13:30', '14:30', '15:30', '16:30'
            ];
            
            let html = '';
            
            timeOptions.forEach(time => {
                const isTaken = takenSlots.includes(time);
                const isDisabled = isTaken ? 'disabled' : '';
                const isSelected = selectedTime === time ? 'selected' : '';
                
                html += `
                    <div class="time-option ${isDisabled} ${isSelected}" 
                         onclick="${!isTaken ? `selectTime('${time}')` : ''}">
                        ${time} ${isTaken ? '(DOLU)' : ''}
                    </div>
                `;
            });
            
            document.getElementById('timeOptions').innerHTML = html;
        }
        
        // Form gönderimi
        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const messageDiv = document.getElementById('message');
            
            // CAPTCHA kontrolü
            const userCaptcha = parseInt(document.getElementById('captchaInput').value);
            if (userCaptcha !== mathResult) {
                messageDiv.className = 'error';
                messageDiv.textContent = 'Güvenlik doğrulaması başarısız. Lütfen tekrar deneyin.';
                messageDiv.style.display = 'block';
                generateCaptcha();
                document.getElementById('captchaInput').value = '';
                return;
            }
            
            // Form verilerini topla
            const formData = {
                veliAdiSoyadi: document.getElementById('parentName').value.trim(),
                telefon: document.getElementById('phone').value.trim(),
                ogrenciAdiSoyadi: document.getElementById('studentName').value.trim(),
                ogrenciSinifi: document.getElementById('grade').value,
                randevuTarihi: document.getElementById('appointmentDate').value,
                secilenOda: selectedRoom,
                randevuSaati: selectedTime
            };
            
            // Zorunlu alanları kontrol et
            for (let key in formData) {
                if (!formData[key]) {
                    messageDiv.className = 'error';
                    messageDiv.textContent = 'Lütfen tüm zorunlu alanları doldurun.';
                    messageDiv.style.display = 'block';
                    return;
                }
            }
            
            // Butonu devre dışı bırak
            submitBtn.disabled = true;
            submitBtn.textContent = 'Kaydediliyor...';
            
            try {
                // AppScript'e POST isteği gönder
                const response = await fetch(APPSCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.result === 'success') {
                    // Başarılı
                    messageDiv.className = 'success';
                    messageDiv.textContent = '✅ ' + result.message;
                    messageDiv.style.display = 'block';
                    
                    // Facebook Pixel Lead Event
                    if (typeof fbq !== 'undefined') {
                        fbq('track', 'Lead');
                    }
                    
                    // Formu temizle
                    resetForm();
                    
                } else {
                    // Hata
                    messageDiv.className = 'error';
                    messageDiv.textContent = '❌ ' + (result.message || 'Bir hata oluştu');
                    messageDiv.style.display = 'block';
                    
                    // Doluluk durumunu yenile
                    checkAvailability();
                }
                
            } catch (error) {
                console.error('Gönderim hatası:', error);
                messageDiv.className = 'error';
                messageDiv.textContent = '❌ Bağlantı hatası. Lütfen daha sonra tekrar deneyin.';
                messageDiv.style.display = 'block';
            } finally {
                // Butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.textContent = 'Randevu Oluştur';
            }
        }
        
        // Formu sıfırla
        function resetForm() {
            document.getElementById('appointmentForm').reset();
            selectedRoom = '';
            selectedTime = '';
            
            // Seçimleri temizle
            document.querySelectorAll('.room-card, .time-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.getElementById('selectedRoom').value = '';
            document.getElementById('selectedTime').value = '';
            
            // CAPTCHA'yı yenile
            generateCaptcha();
            document.getElementById('captchaInput').value = '';
            
            // Tarih sınırlamalarını yenile
            setupDateConstraints();
            
            // Mesajı 5 saniye sonra kaldır
            setTimeout(() => {
                document.getElementById('message').style.display = 'none';
            }, 5000);
        }
        
        // Sayfadan ayrılırken uyarı
        window.addEventListener('beforeunload', function(e) {
            const formFilled = document.getElementById('parentName').value || 
                              document.getElementById('phone').value;
            
            if (formFilled) {
                e.preventDefault();
                e.returnValue = 'Form doldurulmuş. Sayfadan ayrılmak istediğinize emin misiniz?';
            }
        });
    </script>
</body>
</html>
